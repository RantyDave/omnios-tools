# curl -s https://20ft.nz/omnios/pre-ami-clean | sh

cd ~
echo ----------Removing old boot environment
for be in $(beadm list -H | egrep '^r[0-9]*' | cut -f 1 -d ';')
do
	beadm destroy -F -s $be
done

echo ----------Remove build
rm -rf illumos-omnios

echo ----------Change to OmniOS ce package repository
pkg unset-publisher on-nightly
wget -P /etc/ssl/pkg https://downloads.omniosce.org/ssl/omniosce-ca.cert.pem
pkg set-publisher -P -G https://pkg.omniti.com/omnios/r151022/ -g https://pkg.omniosce.org/r151022/core/ omnios
pkg update --deny-new-be --no-backup-be -rv web/ca-bundle
rm /etc/ssl/pkg/omniosce-ca.cert.pem
pkg install pkg:/package/pkg
pkg update

echo ----------Regenerate ssh keys on next boot
rm /etc/ssh/ssh_host*
cat > /etc/init.d/regenerate_ssh << EOF
ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa
ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa
ssh-keygen -f /etc/ssh/ssh_host_ecdsa_key -N '' -t ecdsa
ssh-keygen -f /etc/ssh/ssh_host_ed25519_key -N '' -t ed25519
rm /etc/init.d/regenerate_ssh
EOF
chown root:sys /etc/init.d/regenerate_ssh
chmod 744 /etc/init.d/regenerate_ssh
chmod +x /etc/init.d/regenerate_ssh

echo ----------Cover our tracks
rm -f /var/adm/messages.*
rm -f /var/log/syslog.*
cat /dev/null > /var/adm/messages
cat /dev/null > /var/log/syslog
cat /dev/null > /var/adm/wtmpx
cat /dev/null > /var/adm/utmpxw
svcadm disable -s fmd
find /var/fm/fmd -type f -exec rm {} \;
svcadm enable -s fmd
fmadm reset eft
fmadm reset io-retire
rm -rf /root/.ssh
rm -f /root/.bash_history
rm -f /root/.viminfo

echo ----------Simplify boot
cat > loader.conf.local << EOF
autoboot_delay="0"
beastie_disable="YES"
EOF

echo ----------Make a service for mounting instance disks as swap
cat > /lib/svc/method/ec2-drives-as-swap << EOF
boot_disk=/dev/dsk/$(zpool list -v | egrep 'c1t2[0-9]*d0s0' | awk '{ print $1; }')
all_disks=$(ls -l /dev/dsk/c1t*d0s0 | awk '{ print $9; }')
for disk in $all_disks;
do
  if [ ! "$disk" == "$boot_disk" ]; then
    device=$(readlink -s $disk)
    ls $device 2> /dev/null
    if [ $? == "0" ]; then
    	swap -a $disk
    fi
  fi 
done
EOF
chown root:bin /lib/svc/method/ec2-drives-as-swap 
chmod +x /lib/svc/method/ec2-drives-as-swap 

cat > /lib/svc/manifest/system/ec2-drives-as-swap.xml << EOF
<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<service_bundle type="manifest" name="ec2-drives-as-swap">
    <service name="system/ec2-drives-as-swap" type="service" version="1">
        <create_default_instance enabled="true"/>
        <single_instance/>
        <dependency name="everything" grouping="require_all" restart_on="error" type="service">
            <service_fmri value="svc:/milestone/single-user"/>
        </dependency>
        <method_context>
            <method_credential user="root" group="root"/>
        </method_context>
        <exec_method type="method" name="start" exec="/lib/svc/method/ec2-drives-as-swap" timeout_seconds="60"/>
        <exec_method type="method" name="stop" exec="true" timeout_seconds="60"/>
        <property_group name="startd" type="framework">
            <propval name="duration" type="astring" value="transient"/>
        </property_group>
        <template>
            <common_name>
                <loctext xml:lang="C">
                    EC2 instance drives mounted as swap devices
                </loctext>
            </common_name>
        </template>
    </service>
</service_bundle>
EOF
chown root:sys /lib/svc/manifest/system/ec2-drives-as-swap.xml
svccfg import /lib/svc/manifest/system/ec2-drives-as-swap.xml

echo ----------Removing drivers has to be done last
pkg uninstall --no-backup-be driver/network/platform driver/graphics/atiatom driver/graphics/drm driver/network/afe driver/network/amd8111s driver/network/atge driver/network/bfe driver/network/bge driver/network/bnx driver/network/bnxe driver/network/bpf driver/network/chxge driver/network/dmfe driver/network/emlxs driver/network/eoib driver/network/fcip driver/network/fcp driver/network/fcsm driver/network/fp driver/network/hermon driver/network/hme driver/network/hxge driver/network/ibdma driver/network/ibp driver/network/igb driver/network/iprb driver/network/mxfe driver/network/myri10ge driver/network/nge driver/network/ntxn driver/network/nxge driver/network/ofk driver/network/pcn driver/network/qlc driver/network/rds driver/network/rdsv3 driver/network/rge driver/network/rpcib driver/network/rtls driver/network/sdp driver/network/sdpib driver/network/sfe driver/network/sfxge driver/network/tavor driver/network/usbecm driver/network/vr driver/network/xge driver/network/yge driver/firewire driver/network/elxl driver/pcmcia driver/storage/aac driver/storage/adpu320 driver/storage/amr driver/storage/arcmsr driver/storage/bcm_sata driver/storage/cpqary3 driver/storage/glm driver/storage/lsimega driver/storage/marvell88sx driver/storage/mega_sas driver/storage/mpt_sas driver/storage/mr_sas driver/storage/pmcs driver/storage/sbp2 driver/storage/scsa1394 driver/storage/sdcard driver/storage/ses driver/storage/si3124

echo ----------Poweroff then make AMI

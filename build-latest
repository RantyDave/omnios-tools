# curl -s https://20ft.nz/omnios/build-latest | bash
cd /root

echo ----------Installing tools
# https://omnios.omniti.com/wiki.php/illumos-tools
pkg install --no-refresh illumos-tools developer/gcc44

echo ----------Cloning omniosce source from github
if [ ! -d "illumos-omnios" ]; then
	git clone https://github.com/omniosorg/illumos-omnios.git
	cd illumos\-omnios
else
	cd illumos\-omnios
	git pull
fi
 
echo ----------Patching default build environment
if [ ! -e "my.env" ]; then
cat > pat << EOF
--- /opt/onbld/env/omnios-illumos-omnios        Wed Jul 26 22:03:48 2017
+++ my.env      Wed Jul 26 22:16:25 2017
@@ -45,7 +45,7 @@
 # - This script is only interpreted by ksh93 and explicitly allows the
 #   use of ksh93 language extensions.
 #
-export NIGHTLY_OPTIONS='-FnCDAlmprt'
+export NIGHTLY_OPTIONS='-CAnprti'
 
 #
 # -- PLEASE READ THIS --
@@ -58,10 +58,10 @@
 
 # This is a variable for the rest of the script - GATE doesn't matter to
 # nightly itself
-export GATE='testws'
+export GATE='omniosce'
 
 # CODEMGR_WS - where is your workspace at (or what should nightly name it)
-export CODEMGR_WS="\$HOME/ws/\$GATE"
+export CODEMGR_WS="/root/illumos-omnios"
 
 # Maximum number of dmake jobs.  The recommended number is 2 + NCPUS,
 # where NCPUS is the number of logical CPUs on your build system.
EOF

cp /opt/onbld/env/omnios\-illumos\-omnios my.env
patch --unified my.env < pat
rm pat
fi

echo ----------Building
/bin/time /opt/onbld/bin/nightly my.env

echo ----------Removing tools
pkg uninstall --deny-new-be --no-backup-be illumos-tools developer/gcc44

echo ----------Creating new boot environment
cd ~
/usr/sbin/beadm destroy -F omniosce
/opt/onbld/bin/onu -v -t omniosce -d illumos-omnios/packages/i386/nightly-nd




